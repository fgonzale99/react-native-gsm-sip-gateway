name: Build Android

on:
  push:
    branches:
      - "**"

jobs:
  build_android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Clean and prepare project
        run: |
          cd telon-gateway-app
          # Remove lock file and node_modules
          rm -rf node_modules package-lock.json
          
          # Update package.json for RN 0.72
          sed -i 's/"react-native": "0.80.0"/"react-native": "0.72.9"/' package.json
          sed -i 's/"react": "19.1.0"/"react": "18.2.0"/' package.json
          
          # Install dependencies
          npm install --legacy-peer-deps
      
      - name: Create local.properties
        run: |
          cd telon-gateway-app/android
          echo "sdk.dir=$ANDROID_HOME" > local.properties
      
      - name: Make gradlew executable
        run: |
          cd telon-gateway-app/android
          chmod +x gradlew
      
      - name: Build Android Release Bundle
        run: |
          cd telon-gateway-app/android
          ./gradlew bundleRelease
      
      - name: Upload Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-bundle
          path: telon-gateway-app/android/app/build/outputs/bundle/release/*.aab

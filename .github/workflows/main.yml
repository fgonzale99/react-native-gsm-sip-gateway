name: Build Telon GSM-SIP Gateway

on:
  push:
    branches:
      - "**"
  workflow_dispatch:  # Permite ejecución manual

jobs:
  build_android:
    runs-on: ubuntu-22.04  # Cambiado de ubuntu-20.04 a ubuntu-22.04
    
    env:
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      NODE_OPTIONS: "--max-old-space-size=4096"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: telon-gsm-sip-gateway
      
      - name: Setup Node.js 18 (compatible con Ubuntu 22.04)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: telon-gsm-sip-gateway/package-lock.json
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 31
          build-tools: 30.0.3
          ndk: 21.4.7075529
          cmake: 3.18.1
      
      - name: Accept Android Licenses
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
      - name: Clone Native Dependencies
        run: |
          # Crear estructura de directorios
          mkdir -p dependencies
          cd dependencies
          
          echo "=== Clonando dependencias nativas ==="
          
          # Clonar react-native-tele
          git clone https://github.com/telon-org/react-native-tele.git || echo "⚠️ react-native-tele no disponible"
          
          # Clonar react-native-sip2
          git clone https://github.com/telon-org/react-native-sip2.git || echo "⚠️ react-native-sip2 no disponible"
          
          # Clonar react-native-replace-dialer
          git clone https://github.com/telon-org/react-native-replace-dialer.git || echo "⚠️ react-native-replace-dialer no disponible"
          
          echo "=== Dependencias clonadas ==="
          ls -la
      
      - name: Prepare Project
        run: |
          cd telon-gsm-sip-gateway
          
          echo "=== Estructura del proyecto ==="
          ls -la
          
          echo "=== package.json original ==="
          if [ -f "package.json" ]; then
            cat package.json
          else
            echo "❌ No hay package.json"
          fi
      
      - name: Update package.json for React Native 0.72
        run: |
          cd telon-gsm-sip-gateway
          
          if [ -f "package.json" ]; then
            # Backup del original
            cp package.json package.json.backup
            
            # Actualizar React Native y React
            sed -i 's/"react-native": "0.80.0"/"react-native": "0.72.9"/' package.json
            sed -i 's/"react": "19.1.0"/"react": "18.2.0"/' package.json
            
            echo "=== package.json actualizado ==="
            cat package.json
          else
            echo "❌ No se pudo actualizar package.json - archivo no encontrado"
          fi
      
      - name: Clean and Install Dependencies
        run: |
          cd telon-gsm-sip-gateway
          
          echo "=== Limpiando node_modules ==="
          rm -rf node_modules package-lock.json
          
          echo "=== Instalando dependencias ==="
          npm install --legacy-peer-deps
          
          echo "=== Instalando CLI específico para RN 0.72 ==="
          npm install --save-dev @react-native-community/cli-platform-android@11.3.6 --legacy-peer-deps
      
      - name: Configure Android Project
        run: |
          cd telon-gsm-sip-gateway
          
          echo "=== Configurando Android ==="
          
          # Crear local.properties si no existe
          mkdir -p android
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "ndk.dir=$ANDROID_HOME/ndk/21.4.7075529" >> android/local.properties
          
          # Configurar gradle para RN 0.72 si existe build.gradle
          if [ -f "android/build.gradle" ]; then
            echo "Configurando android/build.gradle..."
            sed -i 's/com.android.tools.build:gradle:[0-9\.]*/com.android.tools.build:gradle:7.4.0/' android/build.gradle
          fi
          
          # Configurar app/build.gradle si existe
          if [ -f "android/app/build.gradle" ]; then
            echo "Configurando android/app/build.gradle..."
            # Asegurar compileSdkVersion
            sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 31/' android/app/build.gradle || \
              sed -i '/android {/a\    compileSdkVersion 31' android/app/build.gradle
            
            # Asegurar targetSdkVersion
            sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 31/' android/app/build.gradle || \
              sed -i '/compileSdkVersion/a\    targetSdkVersion 31' android/app/build.gradle
            
            # Asegurar buildToolsVersion
            sed -i 's/buildToolsVersion "[^"]*"/buildToolsVersion "30.0.3"/' android/app/build.gradle || \
              sed -i '/targetSdkVersion/a\    buildToolsVersion "30.0.3"' android/app/build.gradle
          fi
      
      - name: Create Metro Config
        run: |
          cd telon-gsm-sip-gateway
          
          cat > metro.config.js << 'EOF'
          const { getDefaultConfig } = require('metro-config');
          
          module.exports = (async () => {
            const {
              resolver: { sourceExts, assetExts }
            } = await getDefaultConfig();
            
            return {
              transformer: {
                getTransformOptions: async () => ({
                  transform: {
                    experimentalImportSupport: false,
                    inlineRequires: true,
                  },
                }),
              },
              resolver: {
                assetExts: assetExts.filter(ext => ext !== 'svg'),
                sourceExts: [...sourceExts, 'svg'],
              },
            };
          })();
          EOF
          
          echo "=== metro.config.js creado ==="
          cat metro.config.js
      
      - name: Make Gradlew Executable
        run: |
          cd telon-gsm-sip-gateway/android
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            echo "✅ gradlew hecho ejecutable"
          else
            echo "⚠️ gradlew no encontrado"
          fi
      
      - name: Build Android APK
        run: |
          cd telon-gsm-sip-gateway/android
          
          echo "=== Limpiando proyecto ==="
          ./gradlew clean || echo "⚠️ Clean falló, continuando..."
          
          echo "=== Construyendo APK Debug (para prueba) ==="
          ./gradlew assembleDebug --stacktrace
          
          echo "=== Verificando build ==="
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "✅ APK Debug construido exitosamente"
            ls -lh app/build/outputs/apk/debug/
          else
            echo "❌ APK Debug no encontrado"
            find . -name "*.apk" -type f 2>/dev/null || echo "No se encontraron APKs"
          fi
      
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telon-gateway-apk
          path: |
            telon-gsm-sip-gateway/android/app/build/outputs/apk/**/*.apk
          retention-days: 7
      
      - name: Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            telon-gsm-sip-gateway/android/**/build/reports/**/*
            telon-gsm-sip-gateway/npm-debug.log
          retention-days: 7
